from flytekit import task, workflow
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score
import logging
import os


@task
def load_data(path: str) -> pd.DataFrame:
    # Use the path parameter to support different datasets
    return pd.read_csv(path)


@task
def clean_data(df: pd.DataFrame) -> pd.DataFrame:
    df = df.dropna()
    return df

@task
def features(df: pd.DataFrame) -> (pd.DataFrame, pd.Series):
    if "Status" not in df.columns:
        raise ValueError("Expected column 'Status' not found in data")

    # Extract target column
    y = df.pop("Status")

    # Automatically encode all categorical columns using get_dummies
    df_encoded = pd.get_dummies(df)

    logger = logging.getLogger(__name__)
    logger.info(f"Encoded columns: {df_encoded.columns.tolist()}")

    return df_encoded, y


@task
def train_model(df: pd.DataFrame, y: pd.Series) -> RandomForestClassifier:
    X_train, X_test, y_train, y_test = train_test_split(df, y, test_size=0.2)
    model = RandomForestClassifier(n_estimators=50, random_state=42)
    model.fit(X_train, y_train)
    return model

@task
def evaluate_model(model: RandomForestClassifier, df: pd.DataFrame, y: pd.Series) -> float:
    preds = model.predict(df)
    return float(accuracy_score(y, preds))



@workflow
def ml_pipeline(path: str) -> float:
    df = load_data(path=path)
    df_clean = clean_data(df=df)
    df_feat, y = features(df=df_clean)
    model = train_model(df=df_feat, y=y)
    acc = evaluate_model(model=model, df=df_feat, y=y)
    return acc